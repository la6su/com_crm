# Joomla AI-Driven CRM Component

ÐŸÑ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿ CRM-ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÑÐ¾ ÑÑ‚Ñ€Ð¾Ð³Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐ¾Ð¹ ÑÑ‚Ð°Ð´Ð¸Ð¹ (State Machine), Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ð½Ð° **Joomla 6 + PHP 8.5**.
Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ Ð² Ñ€Ð°Ð¼ÐºÐ°Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ.
**Ð¦ÐµÐ»ÑŒ:** Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ð¸ Ð»Ð¾Ð³Ð¸ÐºÑƒ, Ð³Ð´Ðµ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ "Ð¿ÐµÑ€ÐµÐ¿Ñ€Ñ‹Ð³Ð½ÑƒÑ‚ÑŒ" Ð²Ð¿ÐµÑ€ÐµÐ´ Ð±ÐµÐ· Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð±Ð¸Ð·Ð½ÐµÑ-ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹.

---

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

1. **ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:** ÐŸÐ¾Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ Ð¿Ð°Ð¿ÐºÑƒ `com_crm` Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ `/administrator/components/`.
2. **Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:**
   * Ð’ Ð°Ð´Ð¼Ð¸Ð½ÐºÐµ Joomla Ð¿ÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ: **System -> Install -> Discover** (ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ).
   * ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ **Refresh**, Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ `com_crm` Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ **Install**.
3. **Ð¡Ñ‚Ð°Ñ€Ñ‚:**
   * ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ: `http://localhost:8080/administrator/index.php?option=com_crm&view=companies`
   * ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ **"+ Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ"** Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‚Ð° Ð½Ð¾Ð²Ð¾Ð¹ ÑÐ´ÐµÐ»ÐºÐ¸.

---


## ðŸ— ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

* **Ð¢Ð¸Ð¿:** Native Joomla MVC Component.
* **Service Layer:** Ð’ÑÑ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð² ÐºÐ»Ð°ÑÑÐµ `src/Service/StageService.php`.
  * *ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð¾:* Ð¡ÐµÑ€Ð²Ð¸Ñ Ð½Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ð° Ð¸Ð»Ð¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸, ÐµÐ³Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð²Ð½ÐµÐ´Ñ€ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ñ‡ÐµÑ€ÐµÐ· `new`), Ð° Ð½Ðµ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹.
* **Ð‘Ð” (MySQL):**
  * `#__crm_companies`: ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑŒ.
    * `stage_code` (Indexed): Ð”Ð»Ñ Ð¼Ð³Ð½Ð¾Ð²ÐµÐ½Ð½Ð¾Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ð¾Ñ€Ð¾Ð½Ð¾Ðº.
    * `context_data` (JSON): Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ Ñ„Ð»Ð°Ð³Ð¸ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹ (`has_call`, `invoice_created`). Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ JSON Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð±Ð¸Ð·Ð½ÐµÑ-Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð±ÐµÐ· `ALTER TABLE`.
  * `#__crm_history`: Ð–ÑƒÑ€Ð½Ð°Ð» Ð°ÑƒÐ´Ð¸Ñ‚Ð° (Append-only log).

## ðŸ›¡ ÐœÐ°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€ÑƒÐµÐ¼Ð¾ÑÑ‚ÑŒ (Ð´Ð¾ 10k/day)

1. **Ð˜Ð½Ð´ÐµÐºÑÑ‹:** Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð½Ð° `stage_code` Ð¸ `company_id`.
2. **Write-Heavy Optimization:** Ð—Ð°Ð¿Ð¸ÑÑŒ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð²Ñ‹Ð½ÐµÑÐµÐ½Ð° Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½ÑƒÑŽ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ. ÐŸÑ€Ð¸ ÑÐ²ÐµÑ€Ñ…Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð¸Ð½ÑÐµÑ€Ñ‚Ñ‹ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð² Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ (RabbitMQ) Ð¸Ð»Ð¸ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² ClickHouse.
3. **JSON Context:** ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ "Ñ€Ð°Ð·Ð´ÑƒÐ²Ð°Ð½Ð¸Ñ" ÑÑ…ÐµÐ¼Ñ‹ Ð‘Ð” Ð¿Ñ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… Ð³Ð°Ð»Ð¾Ñ‡ÐµÐº Ð¸ ÑƒÑÐ»Ð¾Ð²Ð¸Ð¹.

---

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (TDD Cycle)
Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¾Ð² Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð° Unit-Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸ (PHPUnit).
Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ñ†Ð¸ÐºÐ»Ð° "Bug -> Fix":
1. **Bug:** ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð¼Ð¾Ð³ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ ÑÐ´ÐµÐ»ÐºÑƒ Ð² "ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾" Ð±ÐµÐ· Ð²Ñ‹ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÑ‡ÐµÑ‚Ð°.
2. **Test:** ÐÐ°Ð¿Ð¸ÑÐ°Ð½ Ñ‚ÐµÑÑ‚ `testCannotSkipInvoiceCreation`. Ð¢ÐµÑÑ‚ ÑƒÐ¿Ð°Ð» (Red).
3. **Fix:** Ð’ `StageService` Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ ÑÑ‚Ñ€Ð¾Ð³Ð¾Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ðµ `req => 'invoice_created'` Ð´Ð»Ñ ÑÑ‚Ð°Ð´Ð¸Ð¸ W3.
4. **Result:** Ð¢ÐµÑÑ‚ Ð¿Ñ€Ð¾ÑˆÐµÐ» (Green).
Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½ `Native Test Runner` Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð±ÐµÐ· Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÐ´Ñ€Ð° CMS.

**ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°:**
```bash
php administrator/components/com_crm/tests/run_tests.php
```

---

## ðŸ¤– AI Workflow (ÐžÑ‚Ñ‡ÐµÑ‚)
Ð”Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸-Ð°Ð³ÐµÐ½Ñ‚Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´, Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð°ÑƒÐ´Ð¸Ñ‚Ð° Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð² Ð²Ð¸Ð´Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° `docs/AI_Workflow.md`
1. **Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð´Ð°:**
   * *Prompt:* "Create Joomla 5 MVC boilerlate with strict types".
   * *Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:* Ð¡ÑÐºÐ¾Ð½Ð¾Ð¼Ð»ÐµÐ½Ð¾ 30 Ð¼Ð¸Ð½ÑƒÑ‚ Ð½Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð².
2. **Ð‘Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ°:**
   * *Prompt:* Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¸Ð· Ð¢Ð—. Ð—Ð°Ð¿Ñ€Ð¾Ñ: "Convert this transition table to PHP array constant".
   * *Validation:* AI Ð´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð» Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð² Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ð¸ ÑÑ‚Ð°Ð´Ð¸Ð¹ (W1/W2), Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¿Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ñƒ Ð·Ð°Ð´Ð°Ñ‡Ð¸.
3. **ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ñ€Ð¸ÑÐºÐ¾Ð²:**
   * ÐšÐ¾Ð´ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½ Ð½Ð° SQL Injection (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ `$db->quoteName`).
   * Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð° Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ CSRF (Ð² ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ðµ).
